generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String           @id @default(cuid())
  email                      String           @unique
  name                       String?
  role                       UserRole         @default(ATHLETIC_DIRECTOR)
  image                      String?
  emailVerified              DateTime?
  hashedPassword             String?
  schoolName                 String?
  teamName                   String?
  mascot                     String?
  stripeCustomerId           String?
  subscriptionId             String?          @unique
  plan                       String?
  trialEnd                   DateTime?
  googleCalendarRefreshToken String?
  googleCalendarAccessToken  String?
  calendarTokenExpiry        DateTime?
  googleCalendarId           String?
  organizationId             String
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt
  subscriptionStatus         String?
  cancellationDate           DateTime?
  deletionScheduledAt        DateTime?
  hasReceivedFreeTrial       Boolean          @default(false)
  city                       String?
  dailyLoginCount            Int              @default(0)
  lastLoginAt                DateTime?
  lastLoginDate              DateTime?
  phone                      String?          @unique
  resetToken                 String?
  resetTokenExpiry           DateTime?
  googleCalendarEmail        String?
  accounts                   Account[]
  emailCampaigns             EmailCampaign[]  @relation("UserEmailCampaigns")
  emailGroups                EmailGroup[]     @relation("UserEmailGroups")
  emailLogs                  EmailLog[]
  games                      Game[]           @relation("GameCreator")
  sessions                   Session[]
  organization               Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription               Subscription?    @relation("UserSubscription", fields: [subscriptionId], references: [id])
  UserLoginEvent             UserLoginEvent[]

  @@index([organizationId])
  @@map("User")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model StripeWebhookEvent {
  id          String   @id
  type        String
  createdAt   DateTime @default(now())
  processedAt DateTime @default(now())

  @@map("StripeWebhookEvent")
}

model CustomColumn {
  id             String       @id @default(uuid())
  name           String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Organization {
  id             String          @id @default(cuid())
  name           String
  district       String?
  state          String?
  timezone       String          @default("America/New_York")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  customColumns  CustomColumn[]
  emailGroups    EmailGroup[]    @relation("OrganizationEmailGroups")
  opponents      Opponent[]
  teams          Team[]
  travelSettings TravelSettings?
  users          User[]
  venues         Venue[]
}

model Sport {
  id     String @id @default(cuid())
  name   String @unique
  season Season
  teams  Team[]
}

model Team {
  id             String       @id @default(cuid())
  name           String
  level          TeamLevel
  gender         Gender?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  sportId        String
  organizationId String
  awayGames      Game[]       @relation("AwayTeam")
  homeGames      Game[]       @relation("HomeTeam")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sport          Sport        @relation(fields: [sportId], references: [id])

  @@index([organizationId])
  @@index([sportId])
}

model Game {
  id                       String                 @id @default(cuid())
  date                     DateTime
  time                     String?
  status                   GameStatus             @default(SCHEDULED)
  notes                    String?
  isHome                   Boolean                @default(true)
  travelRequired           Boolean                @default(false)
  estimatedTravelTime      Int?
  departureTime            DateTime?
  busCount                 Int?
  travelCost               Float?
  calendarSynced           Boolean                @default(false)
  lastSyncedAt             DateTime?
  googleCalendarEventId    String?
  googleCalendarHtmlLink   String?
  customFields             Json?
  customData               Json?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  homeTeamId               String
  awayTeamId               String?
  venueId                  String?
  opponentId               String?
  createdById              String
  actualArrivalTime        DateTime?
  actualDepartureTime      DateTime?
  autoFillBusInfo          Boolean                @default(false)
  busTravel                Boolean                @default(false)
  recommendedArrivalTime   DateTime?
  recommendedDepartureTime DateTime?
  travelTimeMinutes        Int?
  emailLogs                EmailLog[]
  awayTeam                 Team?                  @relation("AwayTeam", fields: [awayTeamId], references: [id])
  createdBy                User                   @relation("GameCreator", fields: [createdById], references: [id])
  homeTeam                 Team                   @relation("HomeTeam", fields: [homeTeamId], references: [id])
  opponent                 Opponent?              @relation(fields: [opponentId], references: [id])
  venue                    Venue?                 @relation(fields: [venueId], references: [id])
  travelRecommendations    TravelRecommendation[]

  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([date])
  @@index([venueId])
  @@index([opponentId])
}

model Venue {
  id             String       @id @default(cuid())
  name           String
  address        String?
  city           String?
  state          String?
  zipCode        String?
  latitude       Float?
  longitude      Float?
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  games          Game[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model EmailLog {
  id        String      @id @default(cuid())
  to        String[]
  cc        String[]
  subject   String
  body      String
  status    EmailStatus @default(PENDING)
  sentAt    DateTime?
  error     String?
  createdAt DateTime    @default(now())
  gameId    String?
  sentById  String?
  game      Game?       @relation(fields: [gameId], references: [id])
  sentBy    User?       @relation(fields: [sentById], references: [id], onDelete: Restrict)

  @@index([gameId])
  @@index([sentById])
  @@index([createdAt])
}

model Opponent {
  id             String       @id @default(cuid())
  name           String
  mascot         String?
  colors         String?
  contact        String?
  phone          String?
  email          String?
  notes          String?
  sortOrder      Int          @default(0) @map("sort_order")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  games          Game[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, sortOrder])
  @@index([organizationId])
}

model TravelRecommendation {
  id                   String    @id @default(cuid())
  gameId               String
  recommendedDeparture DateTime
  recommendedArrival   DateTime
  travelDuration       Int
  trafficCondition     String?
  weatherCondition     String?
  addedToGame          Boolean   @default(false)
  addedAt              DateTime?
  createdAt            DateTime  @default(now())
  game                 Game      @relation(fields: [gameId], references: [id])

  @@index([gameId])
}

model TravelSettings {
  id                   String       @id @default(cuid())
  organizationId       String       @unique
  autoFillEnabled      Boolean      @default(false)
  defaultBufferMinutes Int          @default(45)
  busLoadingMinutes    Int          @default(15)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model EmailGroup {
  id             String          @id @default(uuid())
  name           String
  userId         String
  createdAt      DateTime        @default(now())
  organizationId String
  emails         EmailAddress[]
  campaigns      EmailCampaign[]
  organization   Organization    @relation("OrganizationEmailGroups", fields: [organizationId], references: [id], onDelete: Cascade)
  user           User            @relation("UserEmailGroups", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([userId])
}

model EmailAddress {
  id      String     @id @default(uuid())
  email   String     @unique
  groupId String
  group   EmailGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
}

model EmailCampaign {
  id        String      @id @default(uuid())
  name      String
  subject   String
  body      String
  groupId   String?
  sentAt    DateTime?
  createdAt DateTime    @default(now())
  userId    String
  group     EmailGroup? @relation(fields: [groupId], references: [id])
  user      User        @relation("UserEmailCampaigns", fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id                 String    @id
  customerId         String
  status             String
  planPriceId        String?
  planProductId      String?
  planLookupKey      String?
  planNickname       String?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAt           DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?
  trialStart         DateTime?
  trialEnd           DateTime?
  endedAt            DateTime?
  latestInvoiceId    String?
  lastEventId        String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @default(now()) @updatedAt
  users              User?     @relation("UserSubscription")

  @@map("Subscription")
}

model UserLoginEvent {
  id        String   @id
  userId    String
  provider  String
  ip        String?
  city      String?
  userAgent String?
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

enum UserRole {
  SUPER_ADMIN
  ATHLETIC_DIRECTOR
  ASSISTANT_AD
  COACH
  STAFF
  VENDOR_READ_ONLY
}

enum TeamLevel {
  VARSITY
  JV
  FRESHMAN
  MIDDLE_SCHOOL
  YOUTH
}

enum Gender {
  MALE
  FEMALE
  COED
}

enum Season {
  FALL
  WINTER
  SPRING
  SUMMER
}

enum GameStatus {
  SCHEDULED
  CONFIRMED
  POSTPONED
  CANCELLED
  COMPLETED
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum SubscriptionStatus {
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

enum PlanType {
  MONTHLY
  ANNUAL
}
