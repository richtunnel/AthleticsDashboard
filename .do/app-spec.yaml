# ============================================
# Digital Ocean App Platform Specification
# ============================================
# This file defines the complete app configuration for deployment
# on DigitalOcean App Platform using the custom Dockerfile

name: athletics-dashboard
region: nyc

# Database component - PostgreSQL managed database
databases:
  - engine: PG
    name: adscheduler-db
    num_nodes: 1
    size: db-s-dev-database  # Production: Use db-s-1vcpu-1gb or higher
    version: "16"
    production: true

# Main application service
services:
  - name: web
    # Use Dockerfile in repo root
    dockerfile_path: Dockerfile
    
    # GitHub integration
    github:
      repo: YOUR_GITHUB_USERNAME/YOUR_REPO_NAME
      branch: main
      deploy_on_push: true
    
    # Build configuration
    build_command: ""  # Dockerfile handles build
    
    # Instance sizing
    instance_count: 1
    instance_size_slug: professional-xs  # 1 vCPU, 2GB RAM
    # Options: basic-xxs, basic-xs, professional-xs, professional-s, professional-m
    
    # HTTP configuration
    http_port: 3000
    
    # Health check
    health_check:
      http_path: /api/health
      initial_delay_seconds: 60
      period_seconds: 30
      timeout_seconds: 10
      success_threshold: 1
      failure_threshold: 3
    
    # Auto-scaling (optional)
    # autoscaling:
    #   min_instance_count: 1
    #   max_instance_count: 3
    #   metrics:
    #     cpu:
    #       percent: 80
    
    # Environment variables
    envs:
      # ============================================
      # Database (automatically injected by DO)
      # ============================================
      - key: DATABASE_URL
        scope: RUN_TIME
        type: SECRET
        value: "${adscheduler-db.DATABASE_URL}"
      
      # ============================================
      # Node Environment
      # ============================================
      - key: NODE_ENV
        scope: RUN_TIME
        value: "production"
      
      - key: PORT
        scope: RUN_TIME
        value: "3000"
      
      # ============================================
      # NextAuth Configuration
      # ============================================
      - key: NEXTAUTH_SECRET
        scope: RUN_AND_BUILD_TIME
        type: SECRET
        # Generate with: openssl rand -base64 32
        # Set in DO App Platform dashboard
      
      - key: NEXTAUTH_URL
        scope: RUN_AND_BUILD_TIME
        # Auto-generated by DO or set manually
        value: "https://your-app.ondigitalocean.app"
      
      - key: NEXT_PUBLIC_APP_URL
        scope: RUN_AND_BUILD_TIME
        value: "https://your-app.ondigitalocean.app"
      
      # ============================================
      # Google OAuth & Calendar
      # ============================================
      - key: GOOGLE_CALENDAR_CLIENT_ID
        scope: RUN_TIME
        type: SECRET
      
      - key: GOOGLE_CALENDAR_CLIENT_SECRET
        scope: RUN_TIME
        type: SECRET
      
      - key: GOOGLE_REDIRECT_URI
        scope: RUN_TIME
        value: "https://your-app.ondigitalocean.app/api/auth/calendar-callback"
      
      - key: GOOGLE_MAPS_API_KEY
        scope: RUN_TIME
        type: SECRET
      
      # ============================================
      # Weather API
      # ============================================
      - key: OPENWEATHER_API_KEY
        scope: RUN_TIME
        type: SECRET
      
      # ============================================
      # Email Service (Resend)
      # ============================================
      - key: RESEND_API_KEY
        scope: RUN_TIME
        type: SECRET
      
      - key: EMAIL_FROM
        scope: RUN_TIME
        value: "AD Hub <noreply@yourdomain.com>"
      
      # ============================================
      # OpenAI
      # ============================================
      - key: OPENAI_API_KEY
        scope: RUN_TIME
        type: SECRET
      
      # ============================================
      # Stripe Payment Processing
      # ============================================
      - key: STRIPE_SECRET_KEY
        scope: RUN_TIME
        type: SECRET
      
      - key: STRIPE_WEBHOOK_SECRET
        scope: RUN_TIME
        type: SECRET
      
      - key: STRIPE_MONTHLY_PRICE_ID
        scope: RUN_TIME
        type: SECRET
      
      - key: STRIPE_ANNUAL_PRICE_ID
        scope: RUN_TIME
        type: SECRET
      
      - key: NEXT_PUBLIC_STRIPE_MONTHLY_PRICE_ID
        scope: RUN_AND_BUILD_TIME
      
      - key: NEXT_PUBLIC_STRIPE_ANNUAL_PRICE_ID
        scope: RUN_AND_BUILD_TIME
      
      # ============================================
      # IP Geolocation (optional)
      # ============================================
      - key: IPINFO_API_TOKEN
        scope: RUN_TIME
        type: SECRET
      
      # ============================================
      # Account Cleanup Automation
      # ============================================
      - key: CRON_SECRET
        scope: RUN_TIME
        type: SECRET
      
      - key: ACCOUNT_DELETION_GRACE_DAYS
        scope: RUN_TIME
        value: "14"
      
      - key: ACCOUNT_DELETION_REMINDER_DAYS
        scope: RUN_TIME
        value: "7,1"

# Optional: Static site for marketing/landing page
# static_sites:
#   - name: landing
#     source_dir: /
#     github:
#       repo: YOUR_GITHUB_USERNAME/YOUR_REPO_NAME
#       branch: main
#     output_dir: /public

# Optional: Cron job for account cleanup
# jobs:
#   - name: account-cleanup
#     kind: PRE_DEPLOY  # or POST_DEPLOY
#     run_command: "npx prisma migrate deploy"
#     environment_slug: node-js
#     envs:
#       - key: DATABASE_URL
#         scope: RUN_TIME
#         type: SECRET
#         value: "${adscheduler-db.DATABASE_URL}"
